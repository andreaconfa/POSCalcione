{% extends "base.html" %}
{% block content %}

<h2 id="kds-title" style="margin-top:0;">Kitchen Display — {{ kitchen.name }} ({{ kitchen.prefix }})</h2>

<div class="kds-root">
  <!-- Toolbar: zoom (verrà spostata dentro #kds-zoom-float) -->
  <div class="kds-toolbar" role="toolbar" aria-label="Controlli zoom">
    <div></div>
    <div class="kds-toolbar-right">
      <button id="kds-zoom-dec" type="button" class="kds-toolbtn" title="Zoom -" aria-label="Diminuisci zoom">−</button>
      <span class="kds-zoom-val" id="kds-zoom-val" aria-live="polite">100%</span>
      <button id="kds-zoom-inc" type="button" class="kds-toolbtn" title="Zoom +" aria-label="Aumenta zoom">+</button>
    </div>
  </div>

  <!-- Layout: contenuto + riepilogo fisso a destra -->
  <div class="kds-two-col">
    <div id="kds-wrap" class="kds-grid">
      <div class="tag">Caricamento…</div>
    </div>

    <aside class="kds-summary" aria-label="Riepilogo prodotti">
      <div class="kds-summary__header">
        <h3>Riepilogo prodotti</h3>
        <button id="kds-summary-refresh" type="button" title="Aggiorna">⟳</button>
      </div>
      <ul id="kds-summary-list" class="kds-summary__list">
        <li class="kds-summary__item"><em>Caricamento…</em></li>
      </ul>
    </aside>
  </div>
</div>

<style>
  /* ===== Full-bleed ===== */
  .kds-root{
    width:100vw;
    margin-left:calc(50% - 50vw);
    margin-right:calc(50% - 50vw);
  }

  :root{
    --kds-top: 84px;
    --kds-scale: 1;      /* scala contenuti */
    --kds-ui-scale: 1;   /* scala controlli zoom */
    --kds-name-tab: 0em; /* TAB PERSONALIZZAZIONI (ridotto) */
  }

  /* ===== Toolbar (zoom) originale (verrà mossa nel box fisso) ===== */
  .kds-root > .kds-toolbar{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; margin:4px 0 6px 0; padding:0 8px;
    padding-right: calc(300px + 16px);
  }
  .kds-toolbtn{
    border:1px solid #2a3b5f; background:transparent; color:#e7eefc;
    border-radius:10px; padding:6px 10px; cursor:pointer; font-size:16px; line-height:1;
  }
  .kds-toolbtn:hover{ background:#0f172a; }
  .kds-toolbtn:active{ transform: translateY(1px); }
  .kds-zoom-val{ min-width:3.5em; text-align:center; opacity:.9; font-weight:700; }

  /* ===== Griglia card (colonna sinistra) ===== */
  .kds-two-col{ padding-right:316px; } /* riserva spazio alla sidebar (300 + 16) */
  .kds-grid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap:12px;
    align-items:start;
    padding: 0 8px 12px 8px;
  }

  /* ===== Card ===== */
  .kds-card{
    border:1px solid var(--line, rgba(255,255,255,.12));
    border-radius:12px;
    padding:10px;
    background:var(--cardAlt, rgba(255,255,255,.04));
    display:flex; flex-direction:column; gap:8px;
  }

  /* ===== Header card ===== */
  .kds-header{ display:flex; justify-content:space-between; align-items:center; }
  .pickup{ font-weight:800; font-size:22px; letter-spacing:.5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .badge{
    border:1px solid var(--line, rgba(255,255,255,.18));
    padding:2px 8px; border-radius:999px; font-size:12px; opacity:.9; white-space:nowrap;
  }
  .muted{ opacity:.7; font-size:12px; }

  /* ===== Righe e separatori ===== */
  .kds-lines{ font-size:13px; line-height:1.25; word-break:break-word; white-space:normal; }
  .kds-lines .kds-line{
    padding: 12px 0;
    border-top: 2px dashed #2a3b5f;
  }
  .kds-lines .kds-line:first-child{
    border-top: none;
    padding-top: 4px;
  }

  .kds-opts{ margin:6px 0 0 0; padding-left:18px; opacity:.9; }
  .kds-opts li{ margin:2px 0; }

  .kds-actions{ display:flex; gap:6px; flex-wrap:wrap; margin-top:auto; }
  .kds-btn{ padding:8px 10px; border-radius:10px; border:1px solid var(--line, rgba(255,255,255,.18)); background:transparent; color:inherit; cursor:pointer; }
  .kds-btn.prepare{ background:#1d4ed8; border-color:#1e40af; color:#eaf2ff; }
  .kds-btn.ready{ background:#16a34a; border-color:#166534; color:#eafff0; }
  .kds-btn.delivered{ background:#dc2626; border-color:#991b1b; color:#fff5f5; }

  /* ===== Barra riepilogo a destra ===== */
  .kds-summary{
    position: fixed;
    top: var(--kds-top);
    right: 0;
    width: 300px;
    max-height: calc(100vh - var(--kds-top) - 12px);
    overflow:auto;
    background:#0e1420;
    border-left:1px solid #20283a; border-top:1px solid #20283a; border-bottom:1px solid #20283a;
    border-radius:12px 0 0 12px;
    padding:12px;
    color:#e7eefc;
    z-index: 9999;
  }
  .kds-summary__header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .kds-summary__header h3{ margin:0; font-size:18px; font-weight:800; letter-spacing:.2px; }
  #kds-summary-refresh{
    border:1px solid #2a3b5f; background:transparent; color:#e7eefc;
    border-radius:10px; padding:6px 10px; cursor:pointer; font-size:16px;
  }
  .kds-summary__list{ list-style:none; padding:0; margin:0; }
  .kds-summary__item{
    display:flex; justify-content:space-between; align-items:center;
    padding:8px 10px; border-bottom:1px dashed #24314c; font-size:16px; line-height:1.25;
  }
  .kds-summary__name{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .kds-summary__qty{
    min-width:3.0em; text-align:center; font-weight:900;
    background:#13203a; border-radius:10px; padding:4px 8px; font-size:18px;
  }

  /* ===== ZOOM contenuti ===== */
  body.kds-zoom .kds-two-col{ zoom: var(--kds-scale); }

  /* ===== SOLO ZOOM PINNATO (si ridimensiona con lo zoom) ===== */
  #kds-zoom-float{
    position: fixed;
    top: calc(var(--kds-top) - 44px);  /* sopra la sidebar */
    right: 8px;
    z-index: 10001;
    transform: scale(var(--kds-ui-scale));
    transform-origin: top right;
    pointer-events: none;              /* il contenitore non intercetta i click */
  }
  #kds-zoom-float .kds-toolbar{
    margin: 0;
    padding: 6px 10px;
    padding-right: 10px;
    background: rgba(14,20,32,.95);
    border: 1px solid #20283a;
    border-radius: 10px;
    box-shadow: 0 4px 14px rgba(0,0,0,.25);
    width: auto;
    pointer-events: auto;              /* i bottoni restano cliccabili */
  }

  /* ===== OPZIONI: TAB + FRECCIA (rientro contenuto) ===== */
  .kds-lines .kds-line .kds-line-opts{
    margin-left: calc(2.6em + 1ch + var(--kds-name-tab)) !important;
    padding-left: 12px !important;
    border-left: 3px dotted #33507d !important;
  }
  @media (max-width: 980px){
    :root{ --kds-name-tab: 1.1em; }
  }
  .kds-line-opts ul, .kds-opts, .kds-opts ul{ list-style: none !important; margin:0; padding:0; }
  .kds-line-opts li, .kds-opts li{ margin:6px 0; padding:0; }
  .kds-line-opts li::before, .kds-opts li::before{
    content:"→"; display:inline-block; margin-right:8px; font-weight:800; opacity:.95;
  }
</style>

<script>
(function(){
  const PREFIX = ({{ (prefix or kitchen.prefix) | tojson }}).toUpperCase();
  const wrap = document.getElementById("kds-wrap");

  /* Sidebar posizionata sotto l’H2 */
  function setSidebarTop(){
    const h2 = document.getElementById('kds-title');
    const rect = h2 ? h2.getBoundingClientRect() : null;
    const top = (rect ? rect.bottom : 72) + window.scrollY + 8;
    document.documentElement.style.setProperty('--kds-top', top + 'px');
  }
  window.addEventListener('load', setSidebarTop);
  window.addEventListener('resize', setSidebarTop);

  /* (opzionale) normalizza eventuali blocchi opzioni in .kds-line-opts */
  function normalizeOptionsLayout(scope){
    (scope || document).querySelectorAll('.kds-lines').forEach(lines=>{
      lines.querySelectorAll('.kds-line').forEach(line=>{
        const next = line.nextElementSibling;
        if (next && (next.classList.contains('kds-opts') || next.matches('ul.kds-opts, .options, ul.options'))) {
          attachOpts(line, next);
        }
        line.querySelectorAll(':scope > .kds-opts, :scope > ul.kds-opts, :scope > .options, :scope > ul.options').forEach(inside=>{
          attachOpts(line, inside);
        });
      });
      function attachOpts(line, el){
        let shell = line.querySelector(':scope > .kds-line-opts');
        if (!shell){
          shell = document.createElement('div');
          shell.className = 'kds-line-opts';
          line.appendChild(shell);
        }
        if (el.tagName === 'UL'){
          el.classList.add('kds-opts-ul');
          shell.appendChild(el);
        } else {
          const ul = document.createElement('ul');
          ul.className = 'kds-opts-ul';
          el.querySelectorAll('li').forEach(li=> ul.appendChild(li));
          shell.appendChild(ul);
          el.remove();
        }
      }
    });
  }

  /* Zoom persistente (+ scala della toolbar) */
  const LS_SCALE = 'kds_scale';
  function applyScale(scale){
    const s = Math.max(0.85, Math.min(1.40, scale || 1));
    document.body.classList.add('kds-zoom');
    document.documentElement.style.setProperty('--kds-scale', String(s));     // contenuti
    document.documentElement.style.setProperty('--kds-ui-scale', String(s));  // toolbar zoom
    localStorage.setItem(LS_SCALE, String(s));
    const zv = document.getElementById('kds-zoom-val');
    if (zv) zv.textContent = Math.round(s * 100) + '%';
  }
  (function initZoom(){
    const scale = parseFloat(localStorage.getItem(LS_SCALE) || '1');
    applyScale(isNaN(scale) ? 1 : scale);
    document.getElementById('kds-zoom-inc')?.addEventListener('click', ()=> applyScale((parseFloat(localStorage.getItem(LS_SCALE) || '1') || 1) + 0.05));
    document.getElementById('kds-zoom-dec')?.addEventListener('click', ()=> applyScale((parseFloat(localStorage.getItem(LS_SCALE) || '1') || 1) - 0.05));
  })();

  /* Carica frammento e aggiorna riepilogo */
  async function loadFragment(){
    try{
      const r = await fetch(`/kds/${PREFIX}/fragment?t=${Date.now()}`, {cache:"no-store"});
      wrap.innerHTML = await r.text();
      normalizeOptionsLayout(wrap);   // garantisce tab e frecce anche con markup “sporco”
      computeSummaryFromDOM();
    }catch(e){
      wrap.innerHTML = `<div class="tag">Errore caricamento</div>`;
      const list = document.getElementById('kds-summary-list');
      if (list) list.innerHTML = `<li class="kds-summary__item"><em>Errore caricamento</em></li>`;
    }
  }

  /* === SOLO card attive (attesa/da preparare/in preparazione) === */
  function isActiveCard(card){
    const cls = (card.className || '').toLowerCase();

    // esclusioni chiare
    if (/(ready|completed|complete|delivered|done|served|evaso|evasa|pronto|consegnato|consegnata)/.test(cls)) {
      return false;
    }

    // inclusioni chiare
    if (/(queued|queue|waiting|pending|to[_-]?prepare|da[_-]?preparare|attesa|preparing|prepping|in[_-]?preparazione)/.test(cls)) {
      return true;
    }

    // data-status / attributi
    const ds = (card.getAttribute('data-status') || card.dataset?.status || '').toLowerCase();
    if (ds){
      if (/(ready|completed|delivered|done|served|evas|pronto|consegn)/.test(ds)) return false;
      if (/(queue|waiting|pending|to[_-]?prepare|attesa|prepar)/.test(ds)) return true;
    }

    // testo badge di stato
    const stEl = card.querySelector('.status, .state, .badge, .badge-age, [data-state]');
    const stTxt = (stEl && (stEl.textContent || stEl.getAttribute('data-state')) || '').toLowerCase();
    if (stTxt){
      if (/(ready|pronto|delivered|consegnat|evas|servit|complet)/.test(stTxt)) return false;
      if (/(queue|attesa|pending|da\s*preparare|in\s*preparazione|prepar|prepping)/.test(stTxt)) return true;
    }

    // default prudente: non contare
    return false;
  }

  /* ====== RIEPILOGO STABILE (no “salti” durante l’update) ====== */
  let SUMMARY_ORDER = [];  // ordine stabile (alfabetico) persistente in pagina

  function computeSummaryFromDOM(){
    const listEl = document.getElementById('kds-summary-list');
    if (!listEl) return;

    const acc = new Map();

    // Prendi solo card con stato "attivo"
    const allCards = Array.from((document.getElementById('kds-wrap') || document).querySelectorAll('.kds-card'));
    const cards = allCards.filter(isActiveCard);

    cards.forEach(card=>{
      card.querySelectorAll('.kds-lines .kds-line').forEach(line=>{
        const qEl = line.querySelector('.kds-qty');
        const nEl = line.querySelector('.kds-name');
        if (!qEl || !nEl) return;

        const q = parseInt(String(qEl.textContent||'').replace(/[^\d]/g,''), 10) || 0;
        const name = String(nEl.textContent||'').trim();
        if (!name || q <= 0) return;

        acc.set(name, (acc.get(name) || 0) + q);
      });
    });

    renderSummaryStable(listEl, acc);
  }

  function renderSummaryStable(listEl, map){
    const keepScroll = listEl.scrollTop;

    const entries = Array.from(map.entries());
    if (!entries.length){
      listEl.innerHTML = `<li class="kds-summary__item"><em>Nessun prodotto</em></li>`;
      return;
    }

    // Prima volta: ordine alfabetico
    if (SUMMARY_ORDER.length === 0){
      SUMMARY_ORDER = entries.map(([name])=>name).sort((a,b)=> a.localeCompare(b));
    }else{
      // Aggiungi nuovi item mantenendo ordine alfabetico per i nuovi
      const known = new Set(SUMMARY_ORDER);
      const newcomers = entries.map(([n])=>n).filter(n => !known.has(n)).sort((a,b)=> a.localeCompare(b));
      if (newcomers.length) SUMMARY_ORDER = SUMMARY_ORDER.concat(newcomers);
      // Rimuovi item che non esistono più
      const existing = new Set(entries.map(([n])=>n));
      SUMMARY_ORDER = SUMMARY_ORDER.filter(n => existing.has(n));
    }

    // Mappa <li> esistenti per riuso
    const liByName = new Map();
    Array.from(listEl.children).forEach(li=>{
      const n = li.getAttribute('data-name');
      if (n) liByName.set(n, li);
    });

    // Patch DOM seguendo SUMMARY_ORDER (no rebuild della <ul>)
    const frag = document.createDocumentFragment();
    const qtyByName = new Map(entries);

    SUMMARY_ORDER.forEach(name=>{
      const qty = qtyByName.get(name);
      if (qty == null) return;

      let li = liByName.get(name);
      if (!li){
        li = document.createElement('li');
        li.className = 'kds-summary__item';
        li.setAttribute('data-name', name);
        li.innerHTML = `
          <span class="kds-summary__name"></span>
          <span class="kds-summary__qty"></span>
        `;
      }
      const nameSpan = li.querySelector('.kds-summary__name');
      const qtySpan  = li.querySelector('.kds-summary__qty');
      if (nameSpan) nameSpan.textContent = name;
      if (qtySpan)  qtySpan.textContent  = qty;

      frag.appendChild(li);
    });

    listEl.replaceChildren(frag);
    listEl.scrollTop = keepScroll; // preserva scroll
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  /* Avvio + polling + refresh manuale */
  window.addEventListener("load", function(){
    loadFragment();
    setInterval(computeSummaryFromDOM, 2000);
    setInterval(loadFragment, 10000);
    document.getElementById('kds-summary-refresh')?.addEventListener('click', computeSummaryFromDOM);
    document.addEventListener("ws-poke", function(){
      loadFragment();
      computeSummaryFromDOM();
    });
  });

  /* Sposta SOLO la toolbar di zoom nel contenitore fisso */
  (function pinZoomOnly(){
    const tb = document.querySelector('.kds-toolbar');
    if (!tb) return;
    let holder = document.getElementById('kds-zoom-float');
    if (!holder){
      holder = document.createElement('div');
      holder.id = 'kds-zoom-float';
      document.body.appendChild(holder);
    }
    holder.appendChild(tb);
  })();
})();
</script>

{% endblock %}
